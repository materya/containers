name: Build & Push

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      images:
        description: 'Images to build'
        required: true
        type: choice
        options:
          - datascience
          - metatrader
          - phpdev
          - pywine
          - wine

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      trigger_build: ${{ steps.trigger.outputs.specs }}
      containers: ${{ steps.filter_specs.outputs.changes }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Detect changes
      uses: dorny/paths-filter@v2
      id: trigger
      with:
        filters: |
          specs: 'specs/**'
    - name: Filter specs
      uses: dorny/paths-filter@v2
      id: filter_specs
      with:
        # TODO: find a way to wildcard that
        filters: |
          datascience: 'specs/datascience/**'
          metatrader: 'specs/metatrader/**'
          phpdev: 'specs/phpdev/**'
          pywine: 'specs/pywine/**'
          wine: 'specs/wine/**'

  build_and_push:
    needs: changes
    if: |
      needs.changes.outputs.trigger_build == 'true'
      || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        container:
          - ${{ fromJSON(needs.changes.outputs.containers) }}
          - ${{ github.event.inputs.images }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Packages Docker Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build
        env:
          DOCKER_BUILDKIT: 1
        run: |
          make ${{ matrix.container }}

      - name: Push
        run: |
          make -C specs/${{ matrix.container }} push
